<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Improv Card Distributor</title>
  <!-- External dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <!-- Websim Socket (fallback included) -->
  <script>
    // Check if WebsimSocket is available, otherwise create a fallback
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof WebsimSocket === 'undefined') {
        console.warn('WebsimSocket not found, creating fallback implementation');
        window.WebsimSocket = class WebsimSocketFallback {
          constructor() {
            console.log('Creating WebsimSocket fallback');
            this._collections = {};
          }
          
          collection(type) {
            if (!this._collections[type]) {
              this._collections[type] = {
                filter: (params) => this._createFilteredCollection(type, params),
                getList: () => localStorage.getItem(type) ? JSON.parse(localStorage.getItem(type)) : [],
                create: async (data) => {
                  const items = localStorage.getItem(type) ? JSON.parse(localStorage.getItem(type)) : [];
                  const newItem = {
                    ...data,
                    id: Math.random().toString(36).substring(2, 15),
                    username: 'local-user',
                    created_at: new Date().toISOString()
                  };
                  items.push(newItem);
                  localStorage.setItem(type, JSON.stringify(items));
                  return newItem;
                },
                update: async (id, data) => {
                  const items = localStorage.getItem(type) ? JSON.parse(localStorage.getItem(type)) : [];
                  const index = items.findIndex(item => item.id === id);
                  if (index !== -1) {
                    items[index] = { ...items[index], ...data };
                    localStorage.setItem(type, JSON.stringify(items));
                    return items[index];
                  }
                  throw new Error('Item not found');
                },
                delete: async (id) => {
                  const items = localStorage.getItem(type) ? JSON.parse(localStorage.getItem(type)) : [];
                  const newItems = items.filter(item => item.id !== id);
                  localStorage.setItem(type, JSON.stringify(newItems));
                },
                subscribe: (callback) => {
                  callback(localStorage.getItem(type) ? JSON.parse(localStorage.getItem(type)) : []);
                  return () => {}; // Unsubscribe function
                }
              };
            }
            return this._collections[type];
          }
          
          _createFilteredCollection(type, filterParams) {
            return {
              getList: () => {
                const items = localStorage.getItem(type) ? JSON.parse(localStorage.getItem(type)) : [];
                return items.filter(item => {
                  for (const key in filterParams) {
                    if (item[key] !== filterParams[key]) return false;
                  }
                  return true;
                });
              },
              subscribe: (callback) => {
                callback(this._collections[type].filter(filterParams).getList());
                return () => {}; // Unsubscribe function
              }
            };
          }
        }
      }
      
      // Define window.baseUrl if it doesn't exist
      if (typeof window.baseUrl === 'undefined') {
        window.baseUrl = window.location.origin + window.location.pathname;
      }
      
      // Define window.websim if it doesn't exist
      if (typeof window.websim === 'undefined') {
        window.websim = {
          upload: async (file) => {
            // Fallback for uploading files - returns a data URL
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
          },
          getCreatedBy: async () => {
            return { username: 'user' };
          }
        };
      }
    });
  </script>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Loading indicator */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ffd6ea;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 24px;
      font-weight: bold;
    }

    /* Heartbeat animation to show loading status */
    @keyframes heartbeat {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    #loading span {
      animation: heartbeat 1.5s infinite;
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- Loading indicator displayed until React mounts -->
  <div id="loading">
    <div>
      <div style="text-align:center; margin-bottom:15px;">Loading Improv Card Distributor v1.18.0...</div>
      <div style="height:10px; width:200px; background-color:#f0f0f0; border-radius:5px; margin:0 auto; overflow:hidden;">
        <div style="height:100%; width:50%; background-color:#000; animation: progress-bar 1.5s infinite; border-radius:5px;"></div>
      </div>
    </div>
  </div>
  
  <div id="root"></div>
  
  <!-- Emergency fallback system for player cards -->
  <script>
    // Ultra-reliable fallback system to ensure player cards always display
    window.addEventListener('load', function() {
      const checkCardRendering = function() {
        // On the player view check if cards are rendering
        if (window.location.search.includes('pin=')) {
          setTimeout(function() {
            // Check if we have a card element but no text
            const cardElement = document.querySelector('.card-text');
            const mainContainer = document.querySelector('#root');
            
            if (mainContainer && (!cardElement || cardElement.textContent === "")) {
              console.log('[EMERGENCY] Card rendering verification failed - activating DOM inspector');
              
              // Log the actual DOM for debugging
              console.log('Current DOM structure:', mainContainer.innerHTML);
              
              // Add a direct card display element if needed
              if (!document.getElementById('direct-display-container')) {
                console.log('[EMERGENCY] Creating direct card container');
                const container = document.createElement('div');
                container.id = 'direct-display-container';
                container.style.position = 'fixed';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.backgroundColor = 'white';
                container.style.zIndex = '10000';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.padding = '20px';
                container.style.textAlign = 'center';
                
                container.innerHTML = `
                  <div style="background-color: white; border-radius: 16px; padding: 40px 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px;">
                    <h1 style="font-size: 28px; font-weight: bold; color: black;">Card Display System Activating...</h1>
                    <p style="margin-top: 20px;">Please wait as we retrieve your card.</p>
                    <div style="margin-top: 20px; width: 100%; height: 8px; background-color: #eee; border-radius: 4px; overflow: hidden;">
                      <div style="width: 30%; height: 100%; background-color: #000; border-radius: 4px; animation: progress-bar 1.5s infinite;"></div>
                    </div>
                    <button style="margin-top: 20px; padding: 10px 20px; font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid black; border-radius: 8px; background-color: white;" onclick="window.location.reload()">
                      Refresh Page
                    </button>
                  </div>
                `;
                
                document.body.appendChild(container);
                
                // Try to get player data directly
                if (typeof WebsimSocket !== 'undefined') {
                  try {
                    const room = new WebsimSocket();
                    const searchParams = new URLSearchParams(window.location.search);
                    const pin = searchParams.get('pin');
                    
                    // Try to get the player name from localStorage or URL
                    let playerName = localStorage.getItem('playerName');
                    if (!playerName) {
                      playerName = prompt("Enter your player name to reconnect");
                    }
                    
                    if (pin && playerName) {
                      // Direct attempt to fetch player data
                      room.collection('player')
                        .filter({ session_pin: pin, name: playerName })
                        .getList()
                        .then(players => {
                          if (players && players.length > 0) {
                            const player = players[0];
                            if (player.current_card && player.current_card !== 'END') {
                              container.innerHTML = `
                                <div style="background-color: white; border-radius: 16px; padding: 40px 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px;">
                                  <h1 style="font-size: 36px; font-weight: bold; color: black; word-wrap: break-word; text-shadow: 0 0 1px rgba(0,0,0,0.1); padding: 10px; line-height: 1.4;">
                                    ${player.current_card}
                                  </h1>
                                  <p style="margin-top: 20px; font-style: italic;">Emergency display mode active</p>
                                  <button style="margin-top: 20px; padding: 10px 20px; font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid black; border-radius: 8px; background-color: white;" onclick="window.location.reload()">
                                    Refresh Page
                                  </button>
                                </div>
                              `;
                            } else if (player.current_card === 'END') {
                              container.innerHTML = `
                                <div style="background-color: white; border-radius: 16px; padding: 40px 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px;">
                                  <h1 style="font-size: 36px; font-weight: bold; color: black; word-wrap: break-word; text-shadow: 0 0 1px rgba(0,0,0,0.1); padding: 10px; line-height: 1.4;">
                                    SESSION ENDED
                                  </h1>
                                  <p>Thank you for playing!</p>
                                  <button style="margin-top: 20px; padding: 10px 20px; font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid black; border-radius: 8px; background-color: white;" onclick="window.location.href = window.location.origin + window.location.pathname">
                                    Return to Home
                                  </button>
                                </div>
                              `;
                            }
                          }
                        })
                        .catch(err => {
                          console.error('[EMERGENCY] Error fetching player data:', err);
                        });
                    }
                  } catch (err) {
                    console.error('[EMERGENCY] Failed to use direct data fetch:', err);
                  }
                }
              }
            }
          }, 5000); // Check 5 seconds after load
        }
      };
      
      checkCardRendering();
    });
  </script>
  
  <script type="text/babel" src="app.js"></script>
</body>
</html>